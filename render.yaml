services:
  # Backend API service
  - type: web
    name: bedoui-backend
    runtime: node
    plan: free
    rootDir: ./backend
    buildCommand: >
      apt-get update && \
      apt-get install -y chromium wget ca-certificates libnss3 libatk-bridge2.0-0 libgtk-3-0 libasound2 fonts-liberation || true && \
      npm ci --production --prefer-offline --no-audit --progress=false && \
      npm cache clean --force
    startCommand: node server.js
    autoDeploy: true
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: "5000"
      - key: NODE_VERSION
        value: "20.x"
      - key: PUPPETEER_SKIP_CHROMIUM_DOWNLOAD
        value: "true"
      - key: PUPPETEER_EXECUTABLE_PATH
        value: "/usr/bin/chromium"
      - key: FRONTEND_ORIGIN
        sync: false
      - key: TVA_RATE
        value: "0.20"
      - key: DUPLICATE_WINDOW_SECONDS
        value: "15"
      - key: DOWNLOAD_TOKEN_TTL
        value: "3600"
      # Sensitive variables
      - key: SMTP_HOST
        sync: false
      - key: SMTP_PORT
        sync: false
      - key: SMTP_USER
        sync: false
      - key: SMTP_PASS
        sync: false
      - key: API_KEY
        sync: false
      - key: ENCRYPTION_KEY
        sync: false
      - key: BACKUP_ENCRYPTION_KEY
        sync: false
      - key: DOWNLOAD_TOKEN_SECRET
        sync: false
      - key: RECEIVER_EMAIL
        sync: false
      - key: VITE_SUPABASE_URL
        sync: false
      - key: VITE_SUPABASE_KEY
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: COMPANY_SIRET
        sync: false
      - key: COMPANY_APE
        sync: false
      - key: COMPANY_TVA
        sync: false
      - key: COMPANY_PHONE
        sync: false
      - key: COMPANY_EMAIL
        sync: false
      - key: COMPANY_SITE
        sync: false
      - key: COMPANY_LOGO_URL
        sync: false
      - key: DEVIS_NUMBER
        sync: false

  # Frontend service
  - type: web
    name: bedoui-frontend
    runtime: node
    plan: free
    rootDir: ./frontend
    buildCommand: npm install --include=dev && npm run build
    startCommand: npm run preview
    autoDeploy: true
    envVars:
      - key: NODE_ENV
        value: production
      - key: NODE_VERSION
        value: "20.x"
      - key: PORT
        value: "10000"
      - key: VITE_BACKEND_URL
        sync: false
      - key: VITE_OAUTH_REDIRECT_URL
        sync: false
      # Sensitive variables
      - key: VITE_API_KEY
        sync: false
      - key: VITE_SUPABASE_URL
        sync: false
      - key: VITE_SUPABASE_KEY
        sync: false

